<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Love Portal üíñ</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  
  <script type="module" src="https://unpkg.com/emoji-picker-element@1"></script>

  <style>
    :root {
      --wa-dark: #008069;
      --wa-light: #00a884;
      --wa-bg: #efeae2;
      --wa-chat-me: #d9fdd3;
      --wa-chat-partner: #ffffff;
      --spot-green: #1db954;
      --text-main: #111b21;
      --text-muted: #667781;
      --love-pink: #d81b60;
      --trans-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--wa-bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: var(--text-main); }
    
    /* LOGIN SCREEN */
    #loginScreen { position: fixed; inset: 0; background: var(--wa-bg); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: var(--trans-smooth); }
    .login-box { background: white; padding: 40px 30px; border-radius: 24px; text-align: center; width: 90%; max-width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 15px; }
    .login-box h2 { color: var(--wa-dark); font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
    .login-box p { color: var(--text-muted); font-size: 14px; margin-top: -10px; margin-bottom: 10px; }
    .login-box input { width: 100%; padding: 16px; border-radius: 14px; border: 2px solid #e9edef; text-align: center; outline: none; font-size: 16px; font-weight: bold; letter-spacing: 2px; transition: var(--trans-smooth); color: var(--wa-dark); background: #f0f2f5; }
    .login-box input:focus { border-color: var(--wa-light); background: #fff; box-shadow: 0 0 0 4px rgba(0,168,132,0.1); }
    .login-box button { width: 100%; padding: 16px; background: var(--wa-dark); color: white; border: none; border-radius: 14px; font-weight: bold; font-size: 16px; cursor: pointer; transition: var(--trans-smooth); }
    .login-box button:active { transform: scale(0.97); background: var(--wa-light); }
    #errorMsg { color:#e91e63; font-size:13px; font-weight:bold; display:none; padding-top: 5px; }

    /* HEADER */
    header { background: var(--wa-dark); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 14px; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    #headerAvatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; background: #fff; border: 2px solid rgba(255,255,255,0.2); }
    .header-info { display: flex; flex-direction: column; justify-content: center; flex: 1; overflow: hidden; }
    .header-name { font-size: 17px; font-weight: 600; line-height: 1.2; letter-spacing: 0.2px; }
    .header-status { font-size: 13px; font-weight: 400; color: rgba(255,255,255,0.8); line-height: 1.4; padding-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .action-btn { background: rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 50%; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--trans-smooth); }
    .action-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

    /* SUB-HEADER & MUSIC PLAYER */
    #dynamicSubHeader { position: relative; background: #ffffff; height: 52px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 950; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .sub-view { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; padding: 0 20px 0 16px; transition: var(--trans-smooth); opacity: 0; pointer-events: none; transform: translateY(10px); }
    .sub-view.active { opacity: 1; pointer-events: auto; transform: translateY(0); }

    /* ANNIVERSARY VIEW */
    #anniView { justify-content: flex-start; align-items: center; gap: 15px; padding: 0 16px; } 
    .timer-left { display: flex; align-items: center; gap: 5px; z-index: 2; flex-shrink: 0; }
    .anni-heart { color: #e91e63; font-size: 14px; animation: heartbeat 1.5s infinite ease-in-out; margin-right: 2px; }
    .time-block { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1px; }
    .time-label { font-size: 8px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .time-badge { background: #f0f2f5; padding: 2px 4px; border-radius: 4px; color: var(--wa-dark); font-family: monospace; font-weight: 700; font-size: 13px; min-width: 22px; text-align: center; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    .quote-right { flex: 1; font-size: 11px; font-weight: 600; color: var(--love-pink); text-align: justify; opacity: 1; transition: opacity 0.6s ease; z-index: 2; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; padding-left: 5px; border-left: 1px solid rgba(0,0,0,0.05); }
    
    /* ANIMASI KUPU-KUPU */
    .butterfly-container { position: absolute; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
    .bf-wrapper { position: absolute; will-change: transform; }
    .butterfly { font-size: 14px; display: flex; animation: flutterJitter 3s infinite ease-in-out alternate; will-change: transform; }
    .bf-flap { display: inline-block; animation: flapWings 0.15s infinite alternate; will-change: transform; }
    .bf-c1 { filter: hue-rotate(0deg); } .bf-c2 { filter: hue-rotate(45deg); } .bf-c3 { filter: hue-rotate(90deg); } .bf-c4 { filter: hue-rotate(140deg); } .bf-c5 { filter: hue-rotate(180deg); } .bf-c6 { filter: hue-rotate(220deg); } 
    .bf-1 { top: 20%; left: -5%; animation: pathWideDrift 25s infinite linear; } .bf-1 .butterfly { animation-duration: 2s; font-size: 12px; }
    .bf-2 { top: 60%; left: 110%; animation: pathWideDrift 28s infinite linear reverse; animation-delay: -5s; } .bf-2 .butterfly { animation-duration: 2.5s; font-size: 15px; transform: scaleX(-1); }
    .bf-3 { top: 40%; left: 30%; animation: pathLoop 18s infinite linear; animation-delay: -2s; } .bf-3 .butterfly { animation-duration: 3s; }
    .bf-4 { top: 70%; left: 80%; animation: pathLoop 22s infinite linear reverse; animation-delay: -8s; } .bf-4 .butterfly { animation-duration: 3.5s; font-size: 13px; transform: scaleX(-1); }
    .bf-5 { top: 10%; left: 50%; animation: pathErratic 15s infinite ease-in-out; } .bf-5 .butterfly { animation-duration: 1.5s; font-size: 11px; }
    .bf-6 { top: 80%; left: 20%; animation: pathWideDrift 30s infinite linear; animation-delay: -15s; } .bf-6 .butterfly { animation-duration: 2.8s; font-size: 14px; }
    .bf-7 { top: 30%; left: 90%; animation: pathErratic 19s infinite ease-in-out reverse; animation-delay: -3s; } .bf-7 .butterfly { animation-duration: 2.2s; font-size: 12px; transform: scaleX(-1); }
    .bf-8 { top: 50%; left: 40%; animation: pathLoop 24s infinite linear; animation-delay: -12s; } .bf-8 .butterfly { animation-duration: 4s; font-size: 16px; }

    @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.25); } }
    @keyframes flapWings { 0% { transform: scaleX(1); } 100% { transform: scaleX(0.3); } }
    @keyframes flutterJitter { 0% { transform: translateY(0) rotateX(0); } 25% { transform: translateY(-3px) rotateX(10deg); } 50% { transform: translateY(2px) rotateX(-5deg); } 75% { transform: translateY(-2px) rotateX(5deg); } 100% { transform: translateY(0) rotateX(0); } }
    @keyframes pathWideDrift { 0% { transform: translateX(0) translateY(0) rotate(5deg); } 25% { transform: translateX(40vw) translateY(-15px) rotate(-5deg); } 50% { transform: translateX(80vw) translateY(5px) rotate(5deg); } 75% { transform: translateX(120vw) translateY(-10px) rotate(0deg); } 100% { transform: translateX(160vw) translateY(0) rotate(-5deg); } }
    @keyframes pathLoop { 0% { transform: translate(0,0); } 25% { transform: translate(30px, -20px); } 50% { transform: translate(0, -40px); } 75% { transform: translate(-30px, -20px); } 100% { transform: translate(0,0); } }
    @keyframes pathErratic { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(20px, 30px); } 40% { transform: translate(-15px, -20px); } 60% { transform: translate(25px, -10px); } 80% { transform: translate(-10px, 20px); } }

    /* MUSIC ELEMENTS */
    #musicView { justify-content: space-between; }
    .music-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
    .music-cover { min-width: 36px; height: 36px; border-radius: 6px; background: linear-gradient(135deg, var(--spot-green), var(--wa-dark)); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; box-shadow: 0 3px 8px rgba(29, 185, 84, 0.3); transition: border-radius 0.5s ease; animation: spinDisk 5s linear infinite; animation-play-state: paused; }
    .music-cover.playing { border-radius: 50%; animation-play-state: running; }
    .music-cover.loading-pulse { animation: bufferingPulse 1s infinite alternate; border-radius: 6px; }
    @keyframes spinDisk { 100% { transform: rotate(360deg); } }
    @keyframes bufferingPulse { 0% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1.05); } }

    .music-text { display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
    .music-label { font-size: 9px; font-weight: 800; color: var(--spot-green); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 1px; }
    .music-title { font-size: 13px; font-weight: 700; color: var(--text-main); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
    
    .player-controls { display: flex; align-items: center; gap: 8px; }
    .ctrl-btn { background: #f0f2f5; border: none; color: var(--text-muted); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; transition: var(--trans-smooth); position: relative; padding: 0; line-height: 0; }
    .ctrl-btn:active { transform: scale(0.9); background: #e9edef; }
    .play-pause-btn { background: var(--spot-green); color: white; font-size: 14px; box-shadow: 0 3px 8px rgba(29, 185, 84, 0.3); }
    .play-pause-btn:active { background: #189c46; }
    .stop-btn { color: #e91e63; background: #fce4ec; }
    .active-repeat { color: var(--spot-green) !important; background: rgba(29, 185, 84, 0.15) !important; box-shadow: inset 0 0 0 1px var(--spot-green); }
    
    .spinner-icon { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; animation: spinLoader 1s linear infinite; font-size: 14px; line-height: 0; }
    @keyframes spinLoader { 100% { transform: rotate(360deg); } }

    /* CHAT AREA & WA FEATURES */
    main { flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; position: relative; }
    main::-webkit-scrollbar { width: 6px; } main::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
    
    .msg-wrapper { display: flex; flex-direction: column; width: 100%; position: relative; }
    .message { max-width: 82%; padding: 6px 8px 6px 10px; border-radius: 12px; font-size: 14.5px; line-height: 1.4; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .msg-me { background: var(--wa-chat-me); align-self: flex-end; border-top-right-radius: 0; }
    .msg-partner { background: var(--wa-chat-partner); align-self: flex-start; border-top-left-radius: 0; }
    
    .msg-system { background: rgba(0,0,0,0.06); color: var(--text-muted); align-self: center; text-align: center; font-size: 12px; padding: 6px 16px; border-radius: 16px; font-weight: 600; margin: 8px 0; max-width: 90%; }
    
    .msg-content { display: flex; flex-direction: column; }
    .msg-text { word-wrap: break-word; white-space: pre-wrap; margin-bottom: 2px; }
    .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: -2px; }
    .time-stamp { font-size: 10px; color: rgba(0,0,0,0.45); }
    .edited-label { font-size: 10px; color: rgba(0,0,0,0.45); font-style: italic; }
    .deleted-text { font-style: italic; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

    /* QUOTE/REPLY UI */
    .msg-quote { background: rgba(0,0,0,0.05); border-left: 4px solid var(--wa-light); padding: 6px; border-radius: 6px; margin-bottom: 6px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
    .msg-me .msg-quote { background: rgba(0, 128, 105, 0.08); border-left-color: #006c5b; }
    .quote-sender { font-weight: bold; color: var(--wa-light); font-size: 12px; margin-bottom: 2px; }
    .msg-me .quote-sender { color: #006c5b; }
    .quote-text { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

    /* REACTION BADGE */
    .reaction-badge { position: absolute; bottom: -12px; right: 10px; background: white; border: 1px solid #ddd; border-radius: 16px; padding: 2px 6px; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 2; display: flex; gap: 2px; }
    .msg-me .reaction-badge { right: auto; left: 10px; }

    /* OVERLAY CONTEXT MENU & REACTION PICKER */
    #actionOverlay { position: fixed; inset: 0; z-index: 8000; display: none; }
    .context-menu { position: absolute; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 8px; width: 160px; z-index: 8001; overflow: hidden; transform: scale(0.9); opacity: 0; transition: var(--trans-smooth); }
    .context-menu.show { transform: scale(1); opacity: 1; }
    .menu-item { padding: 12px 16px; font-size: 14px; color: var(--text-main); cursor: pointer; transition: background 0.2s; }
    .menu-item:hover { background: #f0f2f5; }
    .menu-item.danger { color: #e91e63; }

    .reaction-picker { position: absolute; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 24px; padding: 8px 12px; display: flex; gap: 12px; z-index: 8001; transform: translateY(10px); opacity: 0; transition: var(--trans-smooth); }
    .reaction-picker.show { transform: translateY(0); opacity: 1; }
    .react-emoji { font-size: 22px; cursor: pointer; transition: transform 0.2s; line-height: 1; }
    .react-emoji:hover { transform: scale(1.3); }
    .react-plus { background: #f0f2f5; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-weight: bold; font-size: 16px; cursor: pointer; }

    /* EMOJI PICKER FULL CONTAINER (NATIVE STYLE) */
    #fullEmojiContainer { position: fixed; bottom: 0; left: 0; right: 0; width: 100vw; height: 45vh; max-height: 400px; z-index: 9000; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); border-top-left-radius: 16px; border-top-right-radius: 16px; overflow: hidden; background: white; animation: slideUpEmoji 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    emoji-picker { width: 100%; height: 100%; --background: white; --indicator-color: var(--wa-dark); }
    @keyframes slideUpEmoji { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* REPLY PREVIEW DI ATAS INPUT */
    #replyPreviewBox { background: #f0f2f5; border-left: 4px solid var(--wa-light); padding: 8px 12px; margin: 0 16px; border-top-left-radius: 8px; border-top-right-radius: 8px; display: none; position: relative; z-index: 900; box-shadow: 0 -2px 5px rgba(0,0,0,0.02); }
    .reply-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .reply-preview-name { font-weight: bold; font-size: 13px; color: var(--wa-light); }
    .reply-preview-close { color: var(--text-muted); cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; }
    .reply-preview-text { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .reply-preview-edit { font-weight: bold; font-size: 13px; color: var(--wa-dark); display: none; }

    /* FOOTER & BUTTONS */
    footer { background: var(--wa-bg); padding: 8px 16px 12px 16px; display: flex; flex-direction: column; z-index: 1000; box-shadow: 0 -1px 2px rgba(0,0,0,0.05); }
    .input-row { display: flex; gap: 8px; align-items: flex-end; }
    
    .icon-btn { background: transparent; border: none; font-size: 22px; color: var(--text-muted); cursor: pointer; padding: 6px; display: flex; align-items: center; justify-content: center; transition: var(--trans-smooth); }
    .icon-btn:active { transform: scale(0.9); filter: brightness(0.8); }

    .input-wrapper { flex: 1; background: white; border-radius: 24px; padding: 10px 16px; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); min-height: 48px; }
    .input-wrapper input { width: 100%; border: none; outline: none; font-size: 15px; background: transparent; color: var(--text-main); }
    .send-btn { background: var(--wa-dark); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 5px rgba(0,128,105,0.3); transition: var(--trans-smooth); flex-shrink: 0; padding: 0; }
    .send-btn:active { transform: scale(0.9) rotate(-10deg); background: var(--wa-light); }

    /* DELETE MODAL (WA STYLE) */
    #deleteModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .del-modal-box { background: white; width: 85%; max-width: 320px; border-radius: 3px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; display: flex; flex-direction: column; gap: 15px; }
    .del-modal-box span { font-size: 15px; color: var(--text-main); }
    .del-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; margin-top: 10px; }
    .del-btn { background: transparent; border: none; padding: 10px 15px; font-size: 14px; font-weight: 600; color: var(--wa-dark); cursor: pointer; text-align: right; text-transform: uppercase; letter-spacing: 0.5px; }
    .del-btn:hover { background: rgba(0,0,0,0.05); }

    /* MODAL PLAYLIST */
    #playlistModal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; align-items: flex-end; justify-content: center; z-index: 5000; opacity: 0; transition: opacity 0.3s ease; }
    #playlistModal.show { opacity: 1; display: flex; }
    .modal-content { background: white; width: 100%; max-width: 500px; border-top-left-radius: 28px; border-top-right-radius: 28px; padding: 24px 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; display: flex; flex-direction: column; gap: 15px; }
    #playlistModal.show .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-header h3 { color: var(--text-main); font-size: 20px; font-weight: 800; }
    .close-modal-btn { background: #f0f2f5; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 16px; color: var(--text-muted); cursor: pointer; transition: var(--trans-smooth); display: flex; align-items: center; justify-content: center; padding: 0; }
    .search-bar-wrapper { flex-shrink: 0; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 10px; border-bottom: 1px solid #f0f2f5; }
    .search-input { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid #e9edef; background: #f9f9f9; font-size: 14px; outline: none; transition: var(--trans-smooth); }
    .search-input:focus { border-color: var(--spot-green); background: white; }
    #playlistContainer { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; padding-bottom: 20px; padding-right: 5px; }
    #playlistContainer::-webkit-scrollbar { width: 5px; }
    #playlistContainer::-webkit-scrollbar-thumb { background: #d1d7db; border-radius: 5px; }
    .song-item { display: flex; justify-content: space-between; padding: 14px 16px; border-radius: 12px; cursor: pointer; align-items: center; background: white; border: 1px solid transparent; transition: var(--trans-smooth); }
    .song-item:hover { background: #f8f9fa; }
    .song-item:active { transform: scale(0.98); background: #f0f2f5; }
    .song-item-info { display: flex; flex-direction: column; gap: 2px; }
    .song-item-title { font-size: 15px; font-weight: 700; color: var(--text-main); }
    .song-item-artist { font-size: 12px; color: var(--text-muted); }

    /* TOAST NOTIFICATION */
    #customToast { visibility: hidden; position: fixed; top: 80px; left: 50%; transform: translate(-50%, -20px); background: rgba(17, 27, 33, 0.9); backdrop-filter: blur(4px); color: white; padding: 10px 20px; border-radius: 30px; z-index: 10000; font-size: 13px; font-weight: 600; opacity: 0; transition: var(--trans-smooth); box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none; }
    #customToast.show { visibility: visible; opacity: 1; transform: translate(-50%, 0); }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div class="login-box">
      <h2>Love Portal <span style="animation: heartbeat 1.5s infinite; display: inline-block;">üíñ</span></h2>
      <p>Enter our private space</p>
      <input type="password" id="inputCode" placeholder="Secret Code" onkeypress="if(event.key==='Enter') doLogin()">
      <button onclick="doLogin()">Enter Now</button>
      <div id="errorMsg">Oops! Wrong code. Try 123456 or 654321!</div>
    </div>
  </div>

  <div id="appScreen" style="display:none; flex-direction:column; height:100%;">
    
    <header>
      <img id="headerAvatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
      <div class="header-info">
        <div class="header-name" id="partnerNameDisplay">Partner</div>
        <div class="header-status" id="partnerStatusDisplay">waiting for connection...</div>
      </div>
      <div class="header-actions">
        <button class="action-btn" onclick="openPlaylist()" title="Open Playlist">üéß</button>
      </div>
    </header>

    <div id="dynamicSubHeader">
      <div id="anniView" class="sub-view active">
        <div class="butterfly-container">
          <div class="bf-wrapper bf-1"><div class="butterfly bf-c1"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-2"><div class="butterfly bf-c2"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-3"><div class="butterfly bf-c3"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-4"><div class="butterfly bf-c4"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-5"><div class="butterfly bf-c5"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-6"><div class="butterfly bf-c6"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-7"><div class="butterfly bf-c2"><span class="bf-flap">ü¶ã</span></div></div>
          <div class="bf-wrapper bf-8"><div class="butterfly bf-c4"><span class="bf-flap">ü¶ã</span></div></div>
        </div>

        <div class="timer-left">
          <span class="anni-heart">‚ù§Ô∏è</span>
          <div class="time-block">
            <span class="time-label">Days</span>
            <span class="time-badge" id="daysCount">0</span>
          </div>
          <div class="time-block">
            <span class="time-label">Hrs</span>
            <span class="time-badge" id="hoursCount">00</span>
          </div>
          <div class="time-block">
            <span class="time-label">Mins</span>
            <span class="time-badge" id="minutesCount">00</span>
          </div>
          <div class="time-block">
            <span class="time-label">Secs</span>
            <span class="time-badge" id="secondsCount">00</span>
          </div>
        </div>

        <div class="quote-right" id="dynamicQuote">Loading love sentences...</div>
      </div>

      <div id="musicView" class="sub-view">
        <div class="music-left">
          <div class="music-cover" id="diskCover">üéµ</div>
          <div class="music-text">
            <span class="music-label">Now Playing</span>
            <span class="music-title" id="musicTitleDisplay">Song Title</span>
          </div>
        </div>
        <div class="player-controls">
          <button class="ctrl-btn" id="btnRepeat" onclick="toggleRepeat()" title="Repeat Song">üîÅ</button>
          <button class="ctrl-btn" onclick="playPrev()">‚èÆ</button>
          <button class="ctrl-btn play-pause-btn" id="btnPlayPause" onclick="togglePlayPause()">‚è∏</button>
          <button class="ctrl-btn" onclick="playNext()">‚è≠</button>
          <button class="ctrl-btn stop-btn" onclick="stopMusicBroadcast()">‚úñ</button>
        </div>
      </div>
    </div>

    <audio id="audioPlayer" preload="auto"></audio>

    <main id="chatBox">
      <div class="msg-system">End-to-End Encrypted. No one outside of this chat can read your messages. üîí</div>
    </main>

    <div id="replyPreviewBox">
      <div class="reply-preview-header">
        <span class="reply-preview-name" id="replyPreviewName">Name</span>
        <span class="reply-preview-edit" id="editPreviewMode">‚úé Edit Message</span>
        <span class="reply-preview-close" onclick="cancelReplyEdit()">‚úñ</span>
      </div>
      <div class="reply-preview-text" id="replyPreviewText">Text...</div>
    </div>

    <footer>
      <div class="input-row">
        <button class="icon-btn" onclick="openEmojiForInput()" title="Insert Emoji">üòä</button>
        <button class="icon-btn" onclick="document.getElementById('imageUpload').click()" title="Attach Image">üìé</button>
        
        <div class="input-wrapper">
          <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
        </div>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
      
      <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
    </footer>
  </div>

  <div id="actionOverlay" onclick="closeAllMenus()"></div>
  
  <div class="context-menu" id="msgContextMenu">
    <div class="menu-item" onclick="handleMenuAction('reply')">‚Ü©Ô∏è Reply</div>
    <div class="menu-item" id="menuEdit" onclick="handleMenuAction('edit')">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="handleMenuAction('copy')">üìã Copy</div>
    <div class="menu-item danger" onclick="handleMenuAction('delete')">üóëÔ∏è Delete</div>
  </div>

  <div class="reaction-picker" id="msgReactionPicker">
    <span class="react-emoji" onclick="sendReaction('üëç')">üëç</span>
    <span class="react-emoji" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="react-emoji" onclick="sendReaction('üòÇ')">üòÇ</span>
    <span class="react-emoji" onclick="sendReaction('üòÆ')">üòÆ</span>
    <span class="react-emoji" onclick="sendReaction('üò¢')">üò¢</span>
    <span class="react-emoji" onclick="sendReaction('üôè')">üôè</span>
    <div class="react-plus" onclick="openFullEmoji()">+</div>
  </div>

  <div id="fullEmojiContainer">
    <emoji-picker></emoji-picker>
  </div>

  <div id="deleteModal" onclick="closeDeleteModal()">
    <div class="del-modal-box" onclick="event.stopPropagation()">
      <span>Delete message?</span>
      <div class="del-actions">
        <button class="del-btn" onclick="executeDelete('me')">Delete for me</button>
        <button class="del-btn" id="btnDeleteEveryone" onclick="executeDelete('everyone')">Delete for everyone</button>
        <button class="del-btn" onclick="closeDeleteModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="playlistModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Playlist üé∂</h3>
        <button class="close-modal-btn" onclick="closeModal(null, true)">‚úñ</button>
      </div>
      <div class="search-bar-wrapper">
        <input type="text" id="searchSong" class="search-input" placeholder="Search song or artist..." onkeyup="filterPlaylist()">
      </div>
      <div id="playlistContainer"></div>
    </div>
  </div>

  <div id="customToast"></div>

  <script>
    // ==========================================
    // 1. FIREBASE CONFIG
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyBiZ5Npq09AYDi9yTbYv5iYSrj9r5BCgxc",
      authDomain: "wassup-nl.firebaseapp.com",
      databaseURL: "https://wassup-nl-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wassup-nl",
      storageBucket: "wassup-nl.firebasestorage.app",
      messagingSenderId: "275519716886",
      appId: "1:275519716886:web:bf1d5ae52623a4c9ed3f37"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // ==========================================
    // 2. VARIABEL GLOBAL
    // ==========================================
    const TANGGAL_JADIAN = "2025-07-30T00:00:00"; 
    let myName = ""; let partnerName = ""; let lastMusicTimestamp = 0;
    let isPlaying = false; let currentSongIndex = -1; let isRepeat = false;
    let isTyping = false; let typingTimer; let idleTimer;
    
    let activeMsgId = null; let replyingTo = null; let editingMsgId = null;
    let emojiTarget = 'reaction'; // Status flag emoji

    const audioPlayer = document.getElementById('audioPlayer');

    // ==========================================
    // 3. QUOTES & PLAYLIST
    // ==========================================
    const romaticQuotes = [
      "Every second with you is a beautiful adventure I never want to end.",
      "You are not just my world, but the universe where I belong forever.",
      "Distance may separate our bodies, but our hearts always beat on the same frequency.",
      "Loving you is the easiest thing I've ever done, and the most beautiful thing I've felt.",
      "Thank you for being the reason behind my smile every single day, my favorite human.",
      "There is no place more comfortable than the warm embrace of your attention."
    ];

    function startRandomQuotes() {
      const quoteEl = document.getElementById('dynamicQuote');
      if(!quoteEl) return;
      quoteEl.innerText = romaticQuotes[Math.floor(Math.random() * romaticQuotes.length)];
      setInterval(() => {
        quoteEl.style.opacity = 0; 
        setTimeout(() => {
          quoteEl.innerText = romaticQuotes[Math.floor(Math.random() * romaticQuotes.length)];
          quoteEl.style.opacity = 1; 
        }, 600); 
      }, 6000); 
    }
    
    const baseSongs = [
      { title: "Sweet Memories", artist: "Pasti Berbunyi", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
      { title: "Perfect For Us", artist: "Malam Indah", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
      { title: "Miss You So Much", artist: "Hujan Sore", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
      { title: "Dancing Together", artist: "Bintang Jatuh", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
      { title: "Last Love", artist: "Selalu Kamu", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }
    ];
    let myPlaylist = [];
    for(let i=0; i<11; i++) { 
      baseSongs.forEach((song) => { myPlaylist.push({ title: `${song.title} Vol.${i+1}`, artist: song.artist, url: song.url }); });
    }

    // ==========================================
    // 4. LOGIN & PRESENCE
    // ==========================================
    function doLogin() {
      const code = document.getElementById('inputCode').value.trim();
      const users = {
        "123456": { name: "BoyName", partner: "GirlName", role: "cowok" },
        "654321": { name: "GirlName", partner: "BoyName", role: "cewek" }
      };

      if(users[code]) {
        try {
          myName = users[code].name; partnerName = users[code].partner;
          document.getElementById('partnerNameDisplay').innerText = partnerName;
          document.getElementById('headerAvatar').src = (users[code].role === 'cowok') ? "https://cdn-icons-png.flaticon.com/512/4140/4140047.png" : "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
          
          const loginEl = document.getElementById('loginScreen'); loginEl.style.opacity = '0';
          setTimeout(() => { loginEl.style.display = 'none'; document.getElementById('appScreen').style.display = 'flex'; }, 300);
          
          audioPlayer.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"; 
          audioPlayer.play().then(() => { audioPlayer.pause(); }).catch(e => console.log("Unlock delayed"));

          startAnniversaryCounter(); 
          initChatSync(); 
          setupPresenceSystem(); 
          initMusicSync();
          startRandomQuotes();
        } catch (e) { console.error("Initialization error:", e); }
      } else {
        const err = document.getElementById('errorMsg'); 
        err.style.display = 'block'; 
        err.style.animation = 'popIn 0.3s ease';
      }
    }

    function startAnniversaryCounter() {
      function update() {
        const diff = new Date().getTime() - new Date(TANGGAL_JADIAN).getTime();
        if (diff < 0) return; 
        document.getElementById('daysCount').innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
        document.getElementById('hoursCount').innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
        document.getElementById('minutesCount').innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
        document.getElementById('secondsCount').innerText = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
      }
      update(); setInterval(update, 1000); 
    }

    function setupPresenceSystem() {
      const myStatusRef = db.ref(`users/${myName}`);
      db.ref('.info/connected').on('value', snap => {
        if (snap.val() === false) return;
        myStatusRef.onDisconnect().set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP }).then(() => {
          myStatusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
        });
      });

      function resetIdle() {
        if(isTyping) return;
        myStatusRef.update({ state: 'online' });
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => { myStatusRef.update({ state: 'afk', last_changed: firebase.database.ServerValue.TIMESTAMP }); }, 60000);
      }
      document.addEventListener('mousemove', resetIdle); document.addEventListener('keypress', resetIdle); document.addEventListener('touchstart', resetIdle);

      document.getElementById('chatInput').addEventListener('input', () => {
        if(!isTyping) { isTyping = true; myStatusRef.update({ state: 'typing' }); }
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => { isTyping = false; myStatusRef.update({ state: 'online' }); resetIdle(); }, 1500); 
      });

      db.ref(`users/${partnerName}`).on('value', snap => {
        const data = snap.val(); const statusEl = document.getElementById('partnerStatusDisplay');
        if(!data) { statusEl.innerText = "offline"; return; }
        if(data.state === 'typing') {
          statusEl.innerText = "typing..."; statusEl.style.color = "var(--wa-chat-me)"; statusEl.style.fontWeight = "600";
        } else if(data.state === 'online') {
          statusEl.innerText = "Online"; statusEl.style.color = "#d9fdd3"; statusEl.style.fontWeight = "400";
        } else {
          const date = new Date(data.last_changed);
          const h = date.getHours().toString().padStart(2, '0'); const m = date.getMinutes().toString().padStart(2, '0');
          statusEl.style.color = "rgba(255,255,255,0.7)"; statusEl.style.fontWeight = "400";
          statusEl.innerText = (data.state === 'afk') ? `Away since ${h}:${m}` : `last seen at ${h}:${m}`;
        }
      });
    }

    // ==========================================
    // 5. CHAT ENGINE (RENDER & SEND)
    // ==========================================
    function formatTime() { const d = new Date(); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }

    function initChatSync() {
      db.ref("chats").limitToLast(100).on("child_added", snap => buildChatUI(snap.key, snap.val()));
      db.ref("chats").on("child_changed", snap => buildChatUI(snap.key, snap.val()));
    }

    function buildChatUI(id, data) {
      if (!data || !data.sender) return; 

      if (data.deletedForMe && data.deletedForMe[myName]) {
        const el = document.getElementById(`msg-${id}`);
        if(el) el.remove();
        return;
      }

      let wrapper = document.getElementById(`msg-${id}`);
      let isNew = false;
      if (!wrapper) {
        isNew = true;
        wrapper = document.createElement('div');
        wrapper.id = `msg-${id}`;
        wrapper.className = 'msg-wrapper';
        document.getElementById('chatBox').appendChild(wrapper);
      }

      const isMe = (data.sender === myName);
      let contentHTML = "";

      if (data.isDeletedForEveryone) {
        contentHTML = `
          <div class="message ${isMe ? 'msg-me' : 'msg-partner'}" onclick="openReactionPicker(event, '${id}')">
            <div class="msg-content">
              <span class="deleted-text">üö´ This message was deleted</span>
              <div class="msg-meta"><span class="time-stamp">${data.time}</span></div>
            </div>
          </div>`;
      } else {
        let quoteHTML = "";
        if (data.replyTo) {
          let repText = data.replyTo.text || "Image";
          quoteHTML = `
            <div class="msg-quote" onclick="scrollToMsg('${data.replyTo.id}')">
              <div class="quote-sender">${data.replyTo.sender === myName ? 'You' : data.replyTo.sender}</div>
              <div class="quote-text">${repText}</div>
            </div>`;
        }

        let reactHTML = "";
        if (data.reactions) {
          let rIcons = Object.values(data.reactions).join("");
          if(rIcons.length > 0) reactHTML = `<div class="reaction-badge">${rIcons}</div>`;
        }

        // Tampilkan gambar jika ada (fitur upload)
        let mediaHTML = "";
        if (data.imageUrl) {
          mediaHTML = `<img src="${data.imageUrl}" style="max-width: 100%; max-height: 250px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; object-fit: contain;" onclick="window.open('${data.imageUrl}', '_blank')">`;
        }

        const editedStr = data.edited ? `<span class="edited-label">Edited</span>` : "";

        contentHTML = `
          <div class="message ${isMe ? 'msg-me' : 'msg-partner'}">
            <div class="msg-content">
              ${quoteHTML}
              ${mediaHTML}
              ${data.text ? `<div class="msg-text">${data.text}</div>` : ''}
              <div class="msg-meta">${editedStr}<span class="time-stamp">${data.time}</span></div>
            </div>
            ${reactHTML}
          </div>
        `;
        
        // INTERAKSI KLIK KIRI & KANAN
        wrapper.onclick = (e) => {
          if (!e.target.closest('.message')) return; 
          if (!e.target.closest('.msg-quote')) { openReactionPicker(e, id); }
        };

        wrapper.oncontextmenu = (e) => {
          if (!e.target.closest('.message')) return; 
          e.preventDefault(); 
          if (!e.target.closest('.msg-quote')) { openContextMenu(e, id, isMe); }
        };
      }

      wrapper.innerHTML = contentHTML;
      wrapper.dataset.sender = data.sender;
      wrapper.dataset.text = data.text || "";
      wrapper.dataset.isDeleted = data.isDeletedForEveryone ? "true" : "false";

      if (isNew) {
        const b = document.getElementById('chatBox');
        setTimeout(() => b.scrollTop = b.scrollHeight, 100); // Timeout agar gambar ter-load dulu
      }
    }

    function scrollToMsg(id) {
      const el = document.getElementById(`msg-${id}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.firstElementChild.style.background = "rgba(0,168,132,0.3)";
        setTimeout(() => el.firstElementChild.style.background = "", 1000);
      }
    }

    function sendMessage() {
      const input = document.getElementById('chatInput'); 
      const text = input.value.trim(); 
      if(!text) return;

      isTyping = false; clearTimeout(typingTimer); db.ref(`users/${myName}`).update({ state: 'online' });

      if (editingMsgId) {
        db.ref(`chats/${editingMsgId}`).update({ text: text, edited: true });
        cancelReplyEdit();
      } else {
        const payload = { sender: myName, text: text, time: formatTime(), timestamp: firebase.database.ServerValue.TIMESTAMP };
        if (replyingTo) payload.replyTo = replyingTo;
        db.ref("chats").push(payload);
        cancelReplyEdit();
      }
      input.value = ""; 
    }

    // ==========================================
    // 6. IMAGE UPLOAD LOGIC
    // ==========================================
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      showToast("Uploading image... ‚è≥");
      
      const storageRef = firebase.storage().ref(`chat_images/${Date.now()}_${file.name}`);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        null, 
        (error) => { showToast("Upload failed! ‚ùå"); console.error(error); }, 
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            const payload = {
              sender: myName,
              text: "", 
              imageUrl: downloadURL,
              time: formatTime(),
              timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            if (replyingTo) payload.replyTo = replyingTo;

            db.ref("chats").push(payload);
            showToast("Image sent! üñºÔ∏è");
            cancelReplyEdit();
          });
        }
      );
      event.target.value = ""; // reset
    }

    // ==========================================
    // 7. MENUS, REACTIONS & ACTIONS
    // ==========================================
    function openContextMenu(e, id, isMe) {
      e.stopPropagation(); activeMsgId = id;
      const overlay = document.getElementById('actionOverlay');
      const menu = document.getElementById('msgContextMenu');
      const wrapper = document.getElementById(`msg-${id}`);
      if (wrapper.dataset.isDeleted === "true") return;

      document.getElementById('menuEdit').style.display = isMe ? 'block' : 'none';
      document.getElementById('btnDeleteEveryone').style.display = isMe ? 'block' : 'none';
      overlay.style.display = 'block'; menu.style.display = 'block';
      
      const menuHeight = 160; 
      let topPos = e.clientY;
      if (topPos + menuHeight > window.innerHeight - 60) topPos = e.clientY - menuHeight;
      menu.style.top = `${topPos}px`;
      
      if (isMe) { menu.style.right = `${window.innerWidth - e.clientX}px`; menu.style.left = 'auto'; } 
      else { menu.style.left = `${e.clientX}px`; menu.style.right = 'auto'; }

      setTimeout(() => menu.classList.add('show'), 10);
    }

    function openReactionPicker(e, id) {
      e.stopPropagation(); activeMsgId = id;
      const wrapper = document.getElementById(`msg-${id}`);
      if (wrapper.dataset.isDeleted === "true") return;

      const overlay = document.getElementById('actionOverlay');
      const picker = document.getElementById('msgReactionPicker');
      overlay.style.display = 'block'; picker.style.display = 'flex';
      
      const rect = e.currentTarget.firstElementChild.getBoundingClientRect();
      let pickerTop = rect.top - 50;
      if(pickerTop < 70) pickerTop = rect.bottom + 10;
      picker.style.top = `${pickerTop}px`;
      
      if (wrapper.dataset.sender === myName) { picker.style.right = `20px`; picker.style.left = 'auto'; } 
      else { picker.style.left = `20px`; picker.style.right = 'auto'; }

      setTimeout(() => picker.classList.add('show'), 10);
    }

    function closeAllMenus() {
      document.getElementById('actionOverlay').style.display = 'none';
      document.getElementById('msgContextMenu').classList.remove('show');
      document.getElementById('msgReactionPicker').classList.remove('show');
      document.getElementById('fullEmojiContainer').style.display = 'none';
      setTimeout(() => { document.getElementById('msgContextMenu').style.display = 'none'; document.getElementById('msgReactionPicker').style.display = 'none'; }, 200);
    }

    function handleMenuAction(action) {
      closeAllMenus();
      const wrapper = document.getElementById(`msg-${activeMsgId}`);
      if(!wrapper) return;
      if (action === 'reply') { replyingTo = { id: activeMsgId, sender: wrapper.dataset.sender, text: wrapper.dataset.text }; editingMsgId = null; showPreviewBox('reply'); } 
      else if (action === 'edit') { editingMsgId = activeMsgId; replyingTo = null; document.getElementById('chatInput').value = wrapper.dataset.text; showPreviewBox('edit'); }
      else if (action === 'copy') { navigator.clipboard.writeText(wrapper.dataset.text); showToast("Message copied"); }
      else if (action === 'delete') { document.getElementById('deleteModal').style.display = 'flex'; setTimeout(() => { document.getElementById('deleteModal').style.opacity = '1'; document.querySelector('.del-modal-box').style.transform = 'scale(1)'; }, 10); }
    }

    function showPreviewBox(mode) {
      const box = document.getElementById('replyPreviewBox'); const nameEl = document.getElementById('replyPreviewName');
      const textEl = document.getElementById('replyPreviewText'); const editEl = document.getElementById('editPreviewMode');
      if (mode === 'reply') { nameEl.style.display = 'block'; editEl.style.display = 'none'; nameEl.innerText = replyingTo.sender === myName ? 'You' : replyingTo.sender; textEl.innerText = replyingTo.text || "Image"; } 
      else { nameEl.style.display = 'none'; editEl.style.display = 'block'; textEl.innerText = document.getElementById(`msg-${editingMsgId}`).dataset.text; }
      box.style.display = 'block'; document.getElementById('chatInput').focus();
    }
    function cancelReplyEdit() { replyingTo = null; editingMsgId = null; document.getElementById('replyPreviewBox').style.display = 'none'; document.getElementById('chatInput').value = ""; }

    function closeDeleteModal() { document.getElementById('deleteModal').style.opacity = '0'; document.querySelector('.del-modal-box').style.transform = 'scale(0.9)'; setTimeout(() => document.getElementById('deleteModal').style.display = 'none', 200); }
    function executeDelete(type) {
      if(!activeMsgId) return;
      if (type === 'everyone') db.ref(`chats/${activeMsgId}`).update({ isDeletedForEveryone: true, text: "", imageUrl: null, replyTo: null });
      else if (type === 'me') db.ref(`chats/${activeMsgId}/deletedForMe/${myName}`).set(true);
      closeDeleteModal(); activeMsgId = null;
    }

    // ==========================================
    // 8. EMOJI ENGINE
    // ==========================================
    function sendReaction(emoji) { if(!activeMsgId) return; db.ref(`chats/${activeMsgId}/reactions/${myName}`).set(emoji); closeAllMenus(); }
    
    function openFullEmoji() { 
      emojiTarget = 'reaction'; 
      document.getElementById('msgReactionPicker').classList.remove('show'); 
      setTimeout(() => document.getElementById('msgReactionPicker').style.display = 'none', 200); 
      document.getElementById('fullEmojiContainer').style.display = 'block'; 
    }

    function openEmojiForInput() {
      emojiTarget = 'input'; 
      const container = document.getElementById('fullEmojiContainer');
      container.style.display = (container.style.display === 'block') ? 'none' : 'block';
    }

    document.querySelector('emoji-picker').addEventListener('emoji-click', e => { 
      if (emojiTarget === 'reaction') {
        sendReaction(e.detail.unicode); 
        document.getElementById('fullEmojiContainer').style.display = 'none'; 
      } else {
        const chatInput = document.getElementById('chatInput');
        chatInput.value += e.detail.unicode; 
        chatInput.focus();
      }
    });

    // Hide emoji if clicking in chat box
    document.getElementById('chatBox').addEventListener('click', () => {
      document.getElementById('fullEmojiContainer').style.display = 'none';
    });


    // ==========================================
    // 9. MUSIC CONTROLS & SYNC
    // ==========================================
    function setSubView(mode) {
      const anni = document.getElementById('anniView'); const music = document.getElementById('musicView');
      if(mode === 'music') { anni.classList.remove('active'); music.classList.add('active'); } 
      else { music.classList.remove('active'); anni.classList.add('active'); }
    }

    function setPlayerLoadingState(isLoading) {
      const playBtn = document.getElementById('btnPlayPause'); const diskCover = document.getElementById('diskCover');
      if(isLoading) { playBtn.innerHTML = '<div class="spinner-icon">üîÑ</div>'; diskCover.classList.remove('playing'); diskCover.classList.add('loading-pulse'); } 
      else { diskCover.classList.remove('loading-pulse'); }
    }

    function broadcastMusicAction(action, index = currentSongIndex) {
      if(index < 0 || index >= myPlaylist.length) return;
      const song = myPlaylist[index];
      if(action === 'play') setPlayerLoadingState(true);
      db.ref("music_state").set({ action: action, songIndex: index, title: song.title, url: song.url, sender: myName, timestamp: Date.now(), seekTime: (action === 'play' ? 0 : audioPlayer.currentTime) });
    }

    function togglePlayPause() { if(currentSongIndex === -1) return; if (isPlaying) broadcastMusicAction("pause"); else broadcastMusicAction("resume"); }
    function playNext() { if(currentSongIndex === -1) return; let nextIdx = currentSongIndex + 1; if(nextIdx >= myPlaylist.length) nextIdx = 0; broadcastMusicAction("play", nextIdx); }
    function playPrev() { if(currentSongIndex === -1) return; let prevIdx = currentSongIndex - 1; if(prevIdx < 0) prevIdx = myPlaylist.length - 1; broadcastMusicAction("play", prevIdx); }
    function stopMusicBroadcast() { db.ref("music_state").set({ action: "stop", sender: myName, timestamp: Date.now() }); }
    function toggleRepeat() { db.ref("music_settings").set({ repeat: !isRepeat, sender: myName }); }

    audioPlayer.onended = () => {
      if (isRepeat) { audioPlayer.play(); } 
      else { db.ref("music_state").once("value", snap => { const state = snap.val(); if(state && state.sender === myName) playNext(); }); }
    };

    function initMusicSync() {
      db.ref("music_settings").on("value", (snapshot) => {
        const data = snapshot.val();
        if(data !== null) {
          isRepeat = data.repeat;
          const btn = document.getElementById('btnRepeat');
          if(isRepeat) { btn.classList.add('active-repeat'); if(data.sender !== myName) showToast(`${data.sender} turned on Repeat üîÅ`); } 
          else { btn.classList.remove('active-repeat'); if(data.sender !== myName) showToast(`${data.sender} turned off Repeat ‚û°Ô∏è`); }
        }
      });

      db.ref("music_state").on("value", (snapshot) => {
        const state = snapshot.val();
        if(!state || state.timestamp === lastMusicTimestamp) return;
        lastMusicTimestamp = state.timestamp;

        const playBtn = document.getElementById('btnPlayPause'); const diskCover = document.getElementById('diskCover');

        if(state.action === "play" || state.action === "resume") {
          currentSongIndex = state.songIndex;
          if (audioPlayer.src !== state.url) { audioPlayer.src = state.url; }

          setSubView('music'); document.getElementById('musicTitleDisplay').innerText = state.title; setPlayerLoadingState(true); 

          const syncAndPlay = () => {
            const timePassed = (Date.now() - state.timestamp) / 1000;
            const targetTime = state.seekTime + timePassed;
            if (Math.abs(audioPlayer.currentTime - targetTime) > 2) { audioPlayer.currentTime = targetTime; }
            const currentActionTimestamp = state.timestamp;

            audioPlayer.play().then(() => {
              if (lastMusicTimestamp !== currentActionTimestamp) { audioPlayer.pause(); return; }
              setPlayerLoadingState(false); playBtn.innerHTML = "‚è∏"; diskCover.classList.add('playing'); isPlaying = true;
            }).catch(() => {
              if (lastMusicTimestamp === currentActionTimestamp) { setPlayerLoadingState(false); showToast("System syncing audio playback."); }
            });
          };

          if (audioPlayer.readyState >= 1) { syncAndPlay(); } else { audioPlayer.onloadedmetadata = () => { syncAndPlay(); audioPlayer.onloadedmetadata = null; }; }
        } 
        else if(state.action === "pause") {
          audioPlayer.currentTime = state.seekTime; audioPlayer.pause();
          setPlayerLoadingState(false); playBtn.innerHTML = "‚ñ∂"; diskCover.classList.remove('playing'); isPlaying = false;
        }
        else if(state.action === "stop") {
          audioPlayer.pause(); audioPlayer.currentTime = 0; setSubView('anni');
          setPlayerLoadingState(false); diskCover.classList.remove('playing'); isPlaying = false; currentSongIndex = -1;
        }
      });
    }

    function openPlaylist() { document.getElementById('searchSong').value = ''; renderPlaylistItems(myPlaylist); const modal = document.getElementById('playlistModal'); modal.style.display = 'flex'; setTimeout(() => modal.classList.add('show'), 10); }
    function renderPlaylistItems(listToRender) {
      const list = document.getElementById('playlistContainer'); list.innerHTML = "";
      if(listToRender.length === 0) { list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:14px;">Song not found üòî</div>`; return; }

      listToRender.forEach((song) => {
        const originalIndex = myPlaylist.findIndex(s => s.url === song.url && s.title === song.title);
        const div = document.createElement('div'); div.className = "song-item";
        div.onclick = () => { closeModal(null, true); broadcastMusicAction("play", originalIndex); }
        const isThisPlaying = (currentSongIndex === originalIndex);
        const iconColor = isThisPlaying ? "var(--spot-green)" : "#ccc"; const titleColor = isThisPlaying ? "var(--spot-green)" : "var(--text-main)";
        const icon = isThisPlaying ? `<div style="display:flex; gap:2px; height:15px; align-items:flex-end;"><div style="width:3px; height:100%; background:var(--spot-green); animation: bounce 1s infinite;"></div><div style="width:3px; height:60%; background:var(--spot-green); animation: bounce 1s infinite 0.2s;"></div><div style="width:3px; height:80%; background:var(--spot-green); animation: bounce 1s infinite 0.4s;"></div></div>` : "‚ñ∂";
        div.innerHTML = `<div class="song-item-info"><span class="song-item-title" style="color:${titleColor}">${song.title}</span><span class="song-item-artist">${song.artist}</span></div><span style="color:${iconColor}; font-size:18px;">${icon}</span>`;
        list.appendChild(div);
      });
    }
    function filterPlaylist() { const query = document.getElementById('searchSong').value.toLowerCase(); const filtered = myPlaylist.filter(song => song.title.toLowerCase().includes(query) || song.artist.toLowerCase().includes(query)); renderPlaylistItems(filtered); }
    function closeModal(e, forceClose = false) { const modal = document.getElementById('playlistModal'); if(forceClose || e.target.id === 'playlistModal') { modal.classList.remove('show'); setTimeout(() => modal.style.display = 'none', 300); } }
    function showToast(msg) { const t = document.getElementById('customToast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
    
    const styleSheet = document.createElement("style"); styleSheet.innerText = "@keyframes bounce { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }"; document.head.appendChild(styleSheet);
  </script>
</body>
</html>
